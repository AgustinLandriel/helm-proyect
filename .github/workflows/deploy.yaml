name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Configurar kubectl
      run: |
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/      

    - name: Instalar Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    # - name: Deploy con Helm
    #   run: |
    #     export KUBECONFIG=$PWD/kubeconfig
    #     helm upgrade --install mi-app ./charts/mi-app \
    #       --namespace default \
    #       --create-namespace \
    #       --wait
    - name: Deploy a Dev
      if: github.ref == 'refs/heads/develop'
      run: |
        helm upgrade --install mi-app-dev ./charts/mi-app \
        --values ./charts/mi-app/values-dev.yaml \
        --namespace dev \
        --create-namespace

    - name: Deploy a Prod  
      if: github.ref == 'refs/heads/main'
      run: |
        helm upgrade --install mi-app-prod ./charts/mi-app \
        --values ./charts/mi-app/values-prod.yaml \
        --namespace prod \
        --create-namespace

    - name: Verificar deploy
      run: |
        export KUBECONFIG=$PWD/kubeconfig
        kubectl get pod
        kubectl get services        